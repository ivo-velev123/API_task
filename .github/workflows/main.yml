name: Test and Deploy pipeline

on:
    push:
        branches:
            - main

permissions:
    id-token: write
    contents: read

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: "3.14"
            
            - name: Install Dependencies
              run: |
                python3 -m venv venv
                source venv/bin/activate
                pip install --upgrade pip
                pip install -r requirements.txt
                pip install pytest

            - name: Run Tests
              run: |
                source venv/bin/activate
                pytest

    deployment:
        needs: test
        runs-on: ubuntu-latest
        if: success()

        steps:
            - name: Checkout Repo
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{ secrets.ROLE }}
                aws-region: eu-north-1

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                terraform_version: 1.5.0

            - name: Terraform Init
              run: terraform init

            - name: Terraform Plan
              env:
                TF_VAR_db_url: ${{ secrets.DB_URL }}
            
              run: terraform plan -lock=false

            - name: Terraform Apply
              if: github.ref == 'refs/heads/main'
              env:
                TF_VAR_db_url: ${{ secrets.DB_URL }}

              run: terraform apply -auto-approve -lock=false