#cloud-config
package_update: true
packages:
  - nginx
  - git
  - docker.io
  - nginx-extras

write_files:
  - path: /etc/nginx/sites-available/my-site.conf
    permissions: '0644'
    content: |
      server {
        listen 80;
        server_name _;

        server_tokens off;
        more_set_headers "Server: https://www.youtube.com/watch?v=dQw4w9WgXcQ&list=RDdQw4w9WgXcQ&start_radio=1";

        location / {
            limit_req zone=api_req burst=20 nodelay;

            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            add_header Content-Security-Policy "default-src 'self'; frame-ancestors 'none'; form-action 'self';" always;
            add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
            add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
            add_header X-Frame-Options "DENY" always;
            add_header X-Content-Type-Options "nosniff" always;
            }
      }

  - path: /etc/nginx/conf.d/rate-limiting.conf
    permissions: '0644'
    content: |
      limit_req_zone $binary_remote_addr zone=api_req:10m rate=10r/s;
      limit_req_status 429;

runcmd:
  - ln -s /etc/nginx/sites-available/my-site.conf /etc/nginx/sites-enabled/
  - rm /etc/nginx/sites-enabled/default
  - systemctl restart nginx
  - systemctl start docker
  - systemctl enable docker
  - git clone https://github.com/ivo-velev123/API_task /home/ubuntu/API_task
  - |
    cat > /home/ubuntu/API_task/.env << 'EOF'
    db_url='${db_url}'
    EOF
  - chmod 600 /home/ubuntu/API_task/.env
  - chown ubuntu:ubuntu /home/ubuntu/API_task/.env
  - docker build -t myapp:latest /home/ubuntu/API_task
  - docker stop myapp || true
  - docker rm myapp || true
  - docker run -d -p 5000:5000 --name myapp myapp:latest
